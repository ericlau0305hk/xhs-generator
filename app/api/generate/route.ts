import { NextRequest, NextResponse } from 'next/server';

interface GenerateRequest {
  topic: string;
  style: 'å¹²è´§' | 'æƒ…æ„Ÿ' | 'äº‰è®®';
}

interface GeneratedContent {
  content: string;
  tags: string[];
  imageSuggestion: string;
}

// ===== çƒ­è¯åº“ï¼šæŒ‰é£æ ¼åˆ†ç±» =====
const BUZZWORDS = {
  'å¹²è´§': [
    'ç»ç»å­', 'yyds', 'å¹²è´§', 'ç ä½', 'å»ºè®®æ”¶è—', 'é¿å‘æŒ‡å—', 'ä¿å§†çº§æ•™ç¨‹',
    'äº²æµ‹æœ‰æ•ˆ', 'æ‰‹æŠŠæ‰‹æ•™ä½ ', 'åè¡€æ•´ç†', 'å‹ç®±åº•', 'ä¸€èˆ¬äººæˆ‘ä¸å‘Šè¯‰',
    'å¤©èŠ±æ¿çº§åˆ«', 'ä¿å§†æ•™ç¨‹', 'æ‡’äººå¿…å¤‡', 'æ•ˆç‡ç¿»å€', 'å°ç™½å¿…çœ‹'
  ],
  'æƒ…æ„Ÿ': [
    'è°æ‡‚å•Š', 'å®¶äººä»¬', 'çœŸçš„ç»äº†', 'ç ´é˜²äº†', 'ç‹ ç‹ å…±æƒ…äº†', 'å¤ªçœŸå®äº†',
    'æ³ªç›®', 'æ²»æ„ˆ', 'æ¸©æš–', 'ç¥ä»™', 'å®è—', 'è¢«æƒŠè‰³åˆ°', 'ç‹ ç‹ å¿ƒåŠ¨',
    'åŸåœ°å°ç¥', 'æ•‘å‘½', 'æˆ³å¿ƒ', 'äººé—´çœŸå®', 'æ¸©æŸ”åˆ°éª¨å­é‡Œ'
  ],
  'äº‰è®®': [
    'æ¸…é†’ä¸€ç‚¹', 'å¤§å®è¯', 'è¡Œä¸šå†…å¹•', 'çœŸç›¸äº†', 'ä¸åä¸å¿«', 'äººé—´æ¸…é†’',
    'æ‰å¿ƒ', 'æ®‹é…·çœŸç›¸', 'ç°å®å°±æ˜¯è¿™ä¹ˆ', 'åˆ«è¢«éª—', 'é¿å‘', 'è¯´ç‚¹çœŸè¯',
    'å¾—ç½ªäºº', 'ç¿»è½¦', 'ç¿»è½¦ç°åœº', 'ç¿»è½¦é¢„è­¦', 'åƒä¸‡åˆ«', 'é†’é†’å§'
  ]
};

// ===== æ™ºèƒ½æå–æ ¸å¿ƒä¸»é¢˜ =====
function extractCoreTopic(input: string): string {
  // å»é™¤å¸¸è§æŒ‡ä»¤è¯
  const instructions = [
    'ç”Ÿæˆä¸€ç¯‡', 'å†™ä¸€ç¯‡', 'å¸®æˆ‘å†™', 'ç»™æˆ‘å†™', 'åˆ›ä½œä¸€ç¯‡',
    'æ¨è', 'ä»‹ç»ä¸€ä¸‹', 'è¯´è¯´', 'èŠèŠ', 'åˆ†äº«',
    'è¦æ±‚', 'éœ€è¦', 'æƒ³è¦', 'è¯·', 'å¸®æˆ‘'
  ];
  
  let cleaned = input.trim();
  
  // å»é™¤æŒ‡ä»¤è¯
  for (const inst of instructions) {
    cleaned = cleaned.replace(new RegExp(inst, 'g'), '');
  }
  
  // å»é™¤"çš„æ•™ç¨‹/çš„ç¬”è®°/çš„åˆ†äº«"ç­‰åç¼€
  cleaned = cleaned.replace(/çš„?(æ•™ç¨‹|ç¬”è®°|åˆ†äº«|æ–‡æ¡ˆ|å†…å®¹|æ–¹æ³•|æ”»ç•¥|æŒ‡å—)$/g, '');
  
  // å»é™¤å¤šä½™ç©ºæ ¼
  cleaned = cleaned.trim();
  
  // å¦‚æœæ¸…ç†åå¤ªçŸ­æˆ–ä¸ºç©ºï¼Œè¿”å›åŸè¾“å…¥çš„ç®€åŒ–ç‰ˆ
  if (cleaned.length < 2 || cleaned.length > 15) {
    // å°è¯•æå–æ ¸å¿ƒåè¯çŸ­è¯­
    const matches = input.match(/[\u4e00-\u9fa5]{2,8}(?:ä½¿ç”¨|å…¥é—¨|å­¦ä¹ |æ“ä½œ|æŠ€å·§|æ–¹æ³•|å·¥å…·|è½¯ä»¶|å¹³å°|æ•™ç¨‹)?/);
    if (matches) {
      return matches[0];
    }
    // è¿”å›å‰10ä¸ªå­—ç¬¦
    return input.slice(0, 10).trim();
  }
  
  return cleaned;
}

// ===== æ™ºèƒ½ Mock å†…å®¹ç”Ÿæˆï¼ˆåŸºäº topic åŠ¨æ€ç”Ÿæˆï¼‰ =====
function generateMockContent(topic: string, style: string, variation: number): GeneratedContent {
  // æå–æ ¸å¿ƒä¸»é¢˜ï¼Œé¿å…æŠŠé•¿å¥å­ç›´æ¥å¡è¿›æ¨¡æ¿
  const coreTopic = extractCoreTopic(topic);
  
  // åŸºäºæå–çš„æ ¸å¿ƒä¸»é¢˜ç”Ÿæˆå†…å®¹
  const displayTopic = coreTopic;
  
  // å¹²è´§é£æ ¼ - ä¸‰ä¸ªå®Œå…¨ä¸åŒçš„æ¨¡æ¿
  const ganhuoTemplates = [
    {
      content: () => `ğŸ’¡${displayTopic}å…¥é—¨æŒ‡å—ï½œæ–°æ‰‹å¿…çœ‹é¿å‘æ”»ç•¥

åˆšæ¥è§¦${displayTopic}çš„å§å¦¹çœ‹è¿‡æ¥ï¼
è¸©äº†æ— æ•°å‘æ€»ç»“å‡ºçš„ç»éªŒï¼Œä»Šå¤©å…¨éƒ¨åˆ†äº«ç»™ä½ ä»¬ğŸ‘‡

ğŸ“š å…¥é—¨3æ­¥èµ°ï¼š
1ï¸âƒ£ å…ˆäº†è§£${displayTopic}çš„åŸºç¡€æ¦‚å¿µï¼Œåˆ«æ€¥ç€ä¸Šæ‰‹
   æ¨èå…ˆçœ‹ç›¸å…³æ•™ç¨‹ï¼Œå»ºç«‹ç³»ç»Ÿè®¤çŸ¥
2ï¸âƒ£ æ‰¾ä¸ªå°é¡¹ç›®ç»ƒæ‰‹ï¼Œä»ç®€å•å¼€å§‹
   ç¬¬ä¸€æ¬¡å°è¯•${displayTopic}ï¼Œå»ºè®®é€‰ä½é—¨æ§›çš„å…¥é—¨æ–¹å¼
3ï¸âƒ£ åŠ å…¥ç›¸å…³ç¤¾ç¾¤ï¼Œå‘æœ‰ç»éªŒçš„äººè¯·æ•™
   å°‘èµ°å¼¯è·¯ï¼Œè·å–ä¸€æ‰‹å®æˆ˜ç»éªŒ

âš ï¸ æ–°æ‰‹å¸¸è§è¯¯åŒºï¼š
âŒ è´ªå¤šæ±‚å…¨ï¼Œä»€ä¹ˆéƒ½æƒ³å­¦ï¼Œç»“æœæ ·æ ·ä¸ç²¾
âŒ åªçœ‹ç†è®ºä¸å®è·µï¼Œçº¸ä¸Šè°ˆå…µæ²¡ç”¨
âŒ é‡åˆ°é—®é¢˜å°±æ”¾å¼ƒï¼Œç¼ºä¹æŒç»­å­¦ä¹ çš„è€å¿ƒ

âœ… æ­£ç¡®å§¿åŠ¿ï¼š
èšç„¦${displayTopic}çš„æ ¸å¿ƒæŠ€èƒ½ â†’ ç³»ç»Ÿå­¦ä¹ ç†è®ºåŸºç¡€ â†’ æŒç»­åŠ¨æ‰‹å®è·µ â†’ å¤ç›˜æ€»ç»“è¿­ä»£

åšæŒ3ä¸ªæœˆï¼Œä½ ä¼šå‘ç°${displayTopic}å…¶å®æ²¡æƒ³è±¡ä¸­é‚£ä¹ˆéš¾ï¼
æœ‰é—®é¢˜è¯„è®ºåŒºç•™è¨€ï¼Œçœ‹åˆ°éƒ½ä¼šå›ğŸ’ª`,
      baseTags: ['å…¥é—¨æŒ‡å—', 'æ–°æ‰‹å¿…çœ‹', 'é¿å‘æ”»ç•¥', 'ç»éªŒåˆ†äº«', 'æŒç»­å­¦ä¹ '],
      imageSuggestion: 'æ–°æ‰‹å…¥é—¨æ•™ç¨‹é£æ ¼é…å›¾ï¼Œæ­¥éª¤æ¸…æ™°å±•ç¤ºï¼Œæ˜äº®çš„ç¬”è®°æœ¬ä¹¦æ¡Œåœºæ™¯'
    },
    {
      content: () => `ğŸ”¥${displayTopic}è¿›é˜¶æŠ€å·§ï½œä»å…¥é—¨åˆ°ç²¾é€šçš„ç§˜å¯†

åš${displayTopic}1å¹´äº†ï¼Œä»å®Œå…¨å°ç™½åˆ°èƒ½ç‹¬å½“ä¸€é¢
å…¨é è¿™5ä¸ªè¿›é˜¶å¿ƒæ³•ï¼Œä»Šå¤©å…¨ç›˜æ‰˜å‡ºğŸ‘‡

ğŸ’ è¿›é˜¶å¿ƒæ³•ï¼š

ğŸ¯ å¿ƒæ³•1ï¼šæ‰¾åˆ°è‡ªå·±çš„å·®å¼‚åŒ–å®šä½
ä¸è¦éšå¤§æµï¼Œè¦åœ¨${displayTopic}é‡Œæ‰¾åˆ°å±äºä½ çš„ç‹¬ç‰¹ä»·å€¼ç‚¹ï¼Œæ‰èƒ½è„±é¢–è€Œå‡º

ğŸ“Š å¿ƒæ³•2ï¼šç”¨æ•°æ®é©±åŠ¨å†³ç­–
æ¯æ¬¡åš${displayTopic}éƒ½è¦è®°å½•æ•°æ®ï¼Œæ‰¾åˆ°æœ€ä¼˜è§£æ³•ï¼Œåˆ«å‡­æ„Ÿè§‰åšäº‹

ğŸ”„ å¿ƒæ³•3ï¼šå»ºç«‹å¯å¤ç”¨çš„SOP
æŠŠ${displayTopic}çš„é‡å¤å·¥ä½œæ ‡å‡†åŒ–ï¼Œæ•ˆç‡æå‡300%ï¼ŒæŠŠæ—¶é—´ç•™ç»™åˆ›é€ æ€§çš„äº‹

ğŸ¤ å¿ƒæ³•4ï¼šæ„å»ºäººè„‰èµ„æºç½‘
${displayTopic}è¿™è¡Œï¼Œäººè„‰å°±æ˜¯é’±è„‰ï¼Œå¤šè®¤è¯†åŒè¡Œï¼Œæœºä¼šè‡ªç„¶æ¥

ğŸ“ˆ å¿ƒæ³•5ï¼šæŒç»­è¿­ä»£å‡çº§
${displayTopic}é¢†åŸŸå˜åŒ–å¿«ï¼Œè¦ä¿æŒå­¦ä¹ æ‰èƒ½ä¸è¢«æ·˜æ±°ï¼Œå»ºç«‹ç«äº‰å£å’

ğŸ’° çœŸå®æˆé•¿è½¨è¿¹ï¼š
â€¢ ç¬¬1ä¸ªæœˆï¼šè¾¹å­¦è¾¹åšï¼Œæ…¢æ…¢æ‘¸ç´¢é—¨é“
â€¢ ç¬¬3ä¸ªæœˆï¼šæ‰¾åˆ°æ–¹æ³•è®ºï¼Œå¼€å§‹ç¨³å®šäº§å‡º
â€¢ ç¬¬6ä¸ªæœˆï¼šå½¢æˆè‡ªå·±çš„é£æ ¼ï¼Œè·å¾—è®¤å¯
â€¢ ç°åœ¨ï¼šæˆä¸ºå°é¢†åŸŸçš„å¤´éƒ¨ï¼Œèµ„æºä¸»åŠ¨æ‰¾ä¸Šé—¨

æƒ³æ·±è€•${displayTopic}çš„å®å­ï¼Œå»ºè®®æ”¶è—æ…¢æ…¢å®è·µï¼`,
      baseTags: ['è¿›é˜¶æŠ€å·§', 'ç»éªŒåˆ†äº«', 'èŒåœºå¹²è´§', 'ä¸ªäººæˆé•¿', 'æ–¹æ³•è®º'],
      imageSuggestion: 'ä¸“ä¸šåŠå…¬æ¡Œé¢ä¿¯æ‹ï¼Œæœ‰æ•°æ®å›¾è¡¨ã€ç¬”è®°æœ¬ã€å’–å•¡ï¼Œä½“ç°é«˜æ•ˆå·¥ä½œçŠ¶æ€'
    },
    {
      content: () => `âš¡åš${displayTopic}å¿…å¤‡çš„5ä¸ªç¥å™¨ï½œæ•ˆç‡ç¿»å€ä¸æ˜¯æ¢¦

ä»Šå¤©åˆ†äº«æˆ‘ç§è—çš„${displayTopic}å·¥å…·æ¸…å•
æ¯ä¸€ä¸ªéƒ½æ˜¯ç”¨äº†å°±å›ä¸å»çš„æ•ˆç‡ç¥å™¨ï¼ğŸ‘‡

ğŸ› ï¸ æˆ‘çš„${displayTopic}å·¥å…·ç®±ï¼š

1ï¸âƒ£ çŸ¥è¯†ç®¡ç†å·¥å…·ï¼ˆå»ºç«‹çŸ¥è¯†ä½“ç³»ï¼‰
   ç”¨æ¥æ•´ç†${displayTopic}ç›¸å…³çš„å­¦ä¹ ç¬”è®°å’Œèµ„æ–™
   æ–¹ä¾¿éšæ—¶æŸ¥é˜…ï¼Œå½¢æˆè‡ªå·±çš„çŸ¥è¯†åº“

2ï¸âƒ£ è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆè§£æ”¾åŒæ‰‹ï¼‰
   æŠŠ${displayTopic}ä¸­çš„é‡å¤æ€§å·¥ä½œè‡ªåŠ¨åŒ–å¤„ç†
   æ¯å¤©çœä¸‹2å°æ—¶ï¼Œä¸“æ³¨é«˜ä»·å€¼çš„äº‹

3ï¸âƒ£ çµæ„Ÿæ”¶é›†å¹³å°ï¼ˆåˆ›æ„æºæ³‰ï¼‰
   ${displayTopic}ç›¸å…³çš„ä¼˜è´¨æ¡ˆä¾‹å’Œçµæ„Ÿèšé›†åœ°
   æ²¡æ€è·¯çš„æ—¶å€™æ¥è¿™é‡Œæ‰¾çµæ„Ÿï¼Œç™¾è¯•ç™¾çµ

4ï¸âƒ£ ä¸“ä¸šç¤¾åŒºï¼ˆäº¤æµåœ£åœ°ï¼‰
   é‡åˆ°${displayTopic}çš„æŠ€æœ¯éš¾é¢˜æ¥è¿™é‡Œé—®
   æœ‰å¾ˆå¤šçƒ­å¿ƒå¤§ä½¬ï¼Œæˆ‘80%çš„é—®é¢˜éƒ½æ˜¯åœ¨è¿™é‡Œè§£å†³çš„

5ï¸âƒ£ æ¨¡æ¿èµ„æºåº“ï¼ˆé€Ÿæˆç§˜ç±ï¼‰
   ${displayTopic}å¸¸ç”¨çš„æ¨¡æ¿å’Œæ¡†æ¶åˆé›†
   èµ¶deadlineçš„æ—¶å€™ç›´æ¥å¥—ç”¨ï¼Œäº‹åŠåŠŸå€

âš ï¸ é‡è¦æé†’ï¼š
å·¥å…·åœ¨ç²¾ä¸åœ¨å¤šï¼Œå…ˆç²¾é€š1-2ä¸ªå†æ‰©å±•
åˆ«è®©å·¥å…·å˜æˆè´Ÿæ‹…ï¼ŒæœåŠ¡äº${displayTopic}æœ¬èº«æ‰æ˜¯ç›®çš„

éœ€è¦å…·ä½“å·¥å…·åç§°çš„è¯„è®ºåŒºæ‰£1ï¼Œæˆ‘æ•´ç†æˆæ¸…å•å‘ä½ ğŸ“©`,
      baseTags: ['æ•ˆç‡å·¥å…·', 'ç¥å™¨æ¨è', 'å¹²è´§åˆ†äº«', 'çœæ—¶çœåŠ›', 'å·¥å…·æ¸…å•'],
      imageSuggestion: 'å·¥å…·å±•ç¤ºé£æ ¼é…å›¾ï¼Œå„ç§APPå›¾æ ‡ã€æ•ˆç‡å·¥å…·æˆªå›¾æ‹¼æ¥ï¼Œç§‘æŠ€æ„Ÿè®¾è®¡'
    }
  ];

  // æƒ…æ„Ÿé£æ ¼ - ä¸‰ä¸ªå®Œå…¨ä¸åŒçš„æ¨¡æ¿
  const qingganTemplates = [
    {
      content: () => `ğŸ’­å…³äº${displayTopic}ï¼Œæˆ‘èŠ±äº†ä¸‰å¹´æ‰æ˜ç™½çš„äº‹

å§å¦¹ä»¬ï¼Œä»Šå¤©æƒ³è·Ÿä½ ä»¬èŠèŠ${displayTopic}...

ä¸‰å¹´å‰ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦${displayTopic}
é‚£æ—¶å€™å……æ»¡æ†§æ†¬ï¼Œè§‰å¾—ä¸€åˆ‡éƒ½ä¼šå¾ˆç¾å¥½
æ¢¦æƒ³ç€å¾ˆå¿«å°±èƒ½æˆä¸ºé«˜æ‰‹

ğŸ˜” ä½†ç°å®ç»™äº†æˆ‘æ²‰é‡ä¸€å‡»
${displayTopic}å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•
æœ‰è¿‡è¿·èŒ«ï¼Œæœ‰è¿‡è‡ªæˆ‘æ€€ç–‘
ç”šè‡³åŠå¤œå¤±çœ ï¼Œæ€€ç–‘è‡ªå·±æ˜¯ä¸æ˜¯é€‰é”™äº†æ–¹å‘
æƒ³è¿‡è¦ä¸è¦æ”¾å¼ƒ...

ğŸŒ± è½¬æœºå‡ºç°åœ¨ç¬¬äºŒå¹´
é‡åˆ°ä¸€ä¸ªåŒæ ·åœ¨${displayTopic}é¢†åŸŸæ·±è€•çš„å‰è¾ˆ
å¥¹è¯´ï¼š"æ‰€æœ‰çš„æˆé•¿éƒ½éœ€è¦æ—¶é—´æ²‰æ·€ï¼Œåˆ«æ€¥"
è¿™å¥è¯åƒä¸€æŸå…‰ç…§è¿›æˆ‘å¿ƒé‡Œï¼Œç‚¹é†’äº†æˆ‘

âœ¨ ç°åœ¨çš„æˆ‘
ä¸å†æ€¥äºæ±‚æˆï¼Œå­¦ä¼šäº†äº«å—${displayTopic}çš„è¿‡ç¨‹
ä¹Ÿæ‰¾åˆ°äº†å±äºè‡ªå·±çš„èŠ‚å¥å’Œæ–¹æ³•
å›å¤´çœ‹ï¼Œé‚£äº›ç…ç†¬çš„æ—¥å­åè€Œæˆäº†æœ€å®è´µçš„è´¢å¯Œ

æƒ³å¯¹æ­£åœ¨${displayTopic}è·¯ä¸ŠæŒ£æ‰çš„ä½ è¯´ï¼š
æ…¢æ…¢æ¥ï¼Œæ¯”è¾ƒå¿«ã€‚ä½ æ¯”ä½ æƒ³è±¡ä¸­æ›´ä¼˜ç§€ğŸ’«

ä½ æœ‰ç±»ä¼¼çš„å¿ƒè·¯å†ç¨‹å—ï¼Ÿè¯„è®ºåŒºèŠèŠğŸ‘‡`,
      baseTags: ['å¿ƒè·¯å†ç¨‹', 'æˆé•¿æ„Ÿæ‚Ÿ', 'æƒ…æ„Ÿå…±é¸£', 'æ¸©æš–æ²»æ„ˆ', 'çœŸå®æ•…äº‹'],
      imageSuggestion: 'æ¸©æš–æ²»æ„ˆç³»é…å›¾ï¼Œæ—¥å‡ºæˆ–é»„æ˜åœºæ™¯ï¼Œç»™äººå¸Œæœ›å’ŒåŠ›é‡çš„ç”»é¢'
    },
    {
      content: () => `ğŸ˜­åšæŒ${displayTopic}çš„ç¬¬100å¤©ï¼Œæˆ‘å·®ç‚¹å´©æºƒäº†...

ä»Šå¤©çœŸçš„å¿ä¸ä½æƒ³è¯´è¯´å¿ƒé‡Œè¯...
ä¸“æ³¨${displayTopic}æ•´æ•´100å¤©äº†
å´æ„Ÿè§‰ç¦»ç›®æ ‡è¿˜æœ‰å¥½è¿œçš„è·ç¦»

ğŸŒ§ï¸ é‚£äº›å´©æºƒçš„ç¬é—´å†å†åœ¨ç›®ï¼š

â€¢ ç¬¬1æ¬¡å¤±è´¥ï¼šä»¥ä¸ºåªæ˜¯è¿æ°”ä¸å¥½ï¼Œæ²¡å…³ç³»
â€¢ ç¬¬10æ¬¡å¤±è´¥ï¼šå¼€å§‹æ€€ç–‘è‡ªå·±çš„èƒ½åŠ›ï¼Œæ˜¯ä¸æ˜¯ä¸é€‚åˆ
â€¢ ç¬¬30æ¬¡å¤±è´¥ï¼šå¤œæ·±äººé™æ—¶å·å·æŠ¹çœ¼æ³ªï¼Œæƒ³æ”¾å¼ƒ
â€¢ ç¬¬60æ¬¡å¤±è´¥ï¼šå‘¨å›´äººçš„è´¨ç–‘å£°è®©æˆ‘åŠ¨æ‘‡
â€¢ ç¬¬100æ¬¡ï¼šä»Šå¤©ï¼Œæˆ‘çœŸçš„ä¸çŸ¥é“è¿˜èƒ½ä¸èƒ½åšæŒä¸‹å»...

ğŸ’Œ ä½†å°±åœ¨åˆšåˆš
æ”¶åˆ°äº†ä¸€æ¡é™Œç”Ÿäººçš„ç•™è¨€ï¼š
"è°¢è°¢ä½ åˆ†äº«çš„${displayTopic}å†…å®¹ï¼Œå¸®äº†æˆ‘å¤§å¿™ï¼Œç»§ç»­åŠ æ²¹ï¼"

çªç„¶å°±è§‰å¾—...
åŸæ¥æˆ‘çš„åšæŒæ˜¯æœ‰æ„ä¹‰çš„
å“ªæ€•åªå¸®åˆ°ä¸€ä¸ªäººï¼Œä¹Ÿå€¼å¾—ğŸ’ª

ç»™åŒæ ·åœ¨åšæŒ${displayTopic}çš„å§å¦¹ä»¬ï¼š
ä½ çš„åŠªåŠ›ï¼Œæœ‰äººçœ‹å¾—è§âœ¨

æ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©ï¼Œä¸€èµ·åŠ æ²¹ï¼`,
      baseTags: ['æƒ…æ„Ÿå…±é¸£', 'åšæŒä¸æ˜“', 'æ¸©æš–æ²»æ„ˆ', 'äººé—´çœŸå®', 'ç»§ç»­å‰è¡Œ'],
      imageSuggestion: 'é›¨åå¤©æ™´çš„ç”»é¢ï¼Œæˆ–æ˜¯ä¸€ä¸ªäººååœ¨çª—è¾¹çœ‹ç€å¤–é¢çš„æ¸©æš–åœºæ™¯'
    },
    {
      content: () => `ğŸŒ¸å› ä¸º${displayTopic}ï¼Œæˆ‘é‡è§äº†æ›´å¥½çš„è‡ªå·±

æƒ³åˆ†äº«ä¸€ä¸ªæ¸©æš–æ²»æ„ˆçš„æ•…äº‹...

ä¸€å¹´å‰ï¼Œæˆ‘çš„ç”Ÿæ´»ä¸€å›¢ç³Ÿ
å·¥ä½œä¸é¡ºã€æ„Ÿæƒ…å—æŒ«ã€èº«ä½“ä¹Ÿå‡ºäº†å°é—®é¢˜
æ•´ä¸ªäººå¤„åœ¨ä½è°·æœŸï¼Œå¯¹æœªæ¥æ²¡æœ‰æœŸå¾…ğŸ˜”

ğŸˆ å¶ç„¶é—´æ¥è§¦äº†${displayTopic}
ä¸€å¼€å§‹åªæ˜¯æŠ±ç€è¯•è¯•çœ‹çš„å¿ƒæ€æ‰“å‘æ—¶é—´
æ²¡æƒ³åˆ°ï¼Œæ…¢æ…¢æ”¹å˜äº†æˆ‘çš„ç”Ÿæ´»è½¨è¿¹...

${displayTopic}è®©æˆ‘å­¦ä¼šäº†ï¼š
âœ¨ ä¸“æ³¨å½“ä¸‹ï¼Œä¸å†ç„¦è™‘æœªæ¥å’Œè¿‡å»
âœ¨ äº«å—åš${displayTopic}çš„è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯åªç›¯ç€ç»“æœ
âœ¨ è®¤è¯†äº†ä¸€ç¾¤å¿—åŒé“åˆçš„æœ‹å‹ï¼Œä¸å†å­¤å•

ğŸ’« æœ€ç¥å¥‡çš„æ˜¯
å½“æˆ‘ä¸å†åˆ»æ„è¿½æ±‚æ”¹å˜æ—¶
ç”Ÿæ´»åè€Œä¸€ç‚¹ç‚¹å˜å¥½äº†ï¼Œåƒè´è¶æ•ˆåº”

ç°åœ¨çš„æˆ‘ï¼š
å·¥ä½œæ‰¾åˆ°äº†æ–°çš„æ–¹å‘å’Œçƒ­æƒ…
èº«ä½“ä¹Ÿè¶Šæ¥è¶Šå¥åº·ï¼Œå¿ƒæ€å¹³å’Œ
æ›´é‡è¦çš„æ˜¯ï¼Œå†…å¿ƒå˜å¾—å……å®è€Œå®é™

å¦‚æœä½ ä¹Ÿåœ¨äººç”Ÿçš„ä½è°·æœŸ
ä¸å¦¨è¯•è¯•${displayTopic}ï¼Œä¹Ÿè®¸ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ”¶è·ğŸŒ·

æŠ±æŠ±æ¯ä¸ªæ­£åœ¨åŠªåŠ›å˜å¥½çš„ä½ ğŸ’•`,
      baseTags: ['æ¸©æš–æ²»æ„ˆ', 'è‡ªæˆ‘æˆé•¿', 'ç”Ÿæ´»æ„Ÿæ‚Ÿ', 'é‡è§ç¾å¥½', 'æ­£èƒ½é‡'],
      imageSuggestion: 'æ¸©é¦¨ç¾å¥½çš„ç”»é¢ï¼Œé²œèŠ±ã€é˜³å…‰ã€æˆ–è€…å¾®ç¬‘çš„äººç‰©ç‰¹å†™ï¼Œä¼ é€’æ¸©æš–æ„Ÿ'
    }
  ];

  // äº‰è®®é£æ ¼ - ä¸‰ä¸ªå®Œå…¨ä¸åŒçš„æ¨¡æ¿
  const zhengyiTemplates = [
    {
      content: () => `ğŸš¨${displayTopic}çš„çœŸç›¸ï½œè¯´ç‚¹å¾—ç½ªäººçš„å¤§å®è¯

ä»Šå¤©å¿…é¡»è¯´è¯´${displayTopic}çš„çœŸç›¸
å¯èƒ½ä¼šè¢«éª‚ï¼Œä½†æˆ‘ä½œä¸ºè¿‡æ¥äººï¼Œä¸åä¸å¿«ğŸ‘‡

âŒ é‚£äº›æ²¡äººå‘Šè¯‰ä½ çš„äº‹å®ï¼š

1ï¸âƒ£ ${displayTopic}å¹¶ä¸é€‚åˆæ‰€æœ‰äºº
åˆ«çœ‹ç½‘ä¸Šäººäººéƒ½åœ¨è°ˆ${displayTopic}
ä½†è¯´å®è¯ï¼Œæœ‰ç›¸å½“ä¸€éƒ¨åˆ†äººæ ¹æœ¬ä¸é€‚åˆåš${displayTopic}
ç›²ç›®è·Ÿé£åªä¼šæµªè´¹æ—¶é—´å’Œé‡‘é’±ï¼Œå¾—ä¸å¿å¤±

2ï¸âƒ£ ${displayTopic}çš„æŠ•å…¥äº§å‡ºæ¯”è¢«ä¸¥é‡é«˜ä¼°
å‰æœŸéœ€è¦å¤§é‡æ—¶é—´å­¦ä¹ å’Œç§¯ç´¯
è€Œä¸”å›æŠ¥å‘¨æœŸå¾ˆé•¿ï¼Œå¾ˆå¤šäººæ’‘ä¸è¿‡å‰3ä¸ªæœˆå°±æ”¾å¼ƒäº†
ç½‘ä¸Šé‚£äº›æœˆå…¥åä¸‡çš„æ¡ˆä¾‹ï¼Œçœ‹çœ‹å°±å¥½

3ï¸âƒ£ ${displayTopic}çš„é—¨æ§›è¢«ä¸¥é‡ä½ä¼°äº†
çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™éœ€è¦ç»¼åˆèƒ½åŠ›
ä¸æ˜¯éšä¾¿å­¦å­¦ã€çœ‹çœ‹æ•™ç¨‹å°±èƒ½åšå¥½çš„

ğŸ¤·â€â™€ï¸ æˆ‘ä¸ºä»€ä¹ˆæ•¢è¯´è¿™äº›ï¼Ÿ

å› ä¸ºæˆ‘è§è¿‡å¤ªå¤šäººåœ¨${displayTopic}ä¸Šæ ½è·Ÿå¤´
æ—¶é—´èŠ±äº†ï¼Œé’±èŠ±äº†ï¼Œæœ€åä»€ä¹ˆä¹Ÿæ²¡å¾—åˆ°
çœŸçš„ä¸å¿å¿ƒçœ‹æ›´å¤šäººèµ°å¼¯è·¯ã€è¢«å‰²éŸ­èœ

ğŸ’¡ æˆ‘çš„å»ºè®®ï¼š
åœ¨æŠ•å…¥${displayTopic}ä¹‹å‰ï¼Œå…ˆé—®è‡ªå·±3ä¸ªé—®é¢˜ï¼š
â€¢ æˆ‘çœŸçš„çƒ­çˆ±${displayTopic}å—ï¼Ÿè¿˜æ˜¯åªæ˜¯çœ‹åˆ«äººåšæˆ‘ä¹Ÿæƒ³åšï¼Ÿ
â€¢ æˆ‘æ„¿æ„ä¸ºæ­¤ä»˜å‡ºå¤šå°‘æ—¶é—´å’Œé‡‘é’±ï¼Ÿ
â€¢ æˆ‘èƒ½æ‰¿å—å¤šé•¿æ—¶é—´æ²¡æœ‰å›æŠ¥ï¼ŸåŠå¹´ï¼Ÿä¸€å¹´ï¼Ÿ

æƒ³æ¸…æ¥šå†è¡ŒåŠ¨ï¼Œæ¯”ç›²ç›®å¼€å§‹æ›´é‡è¦

æœ‰ä¸åŒçœ‹æ³•æ¬¢è¿ç†æ€§è®¨è®ºğŸ‘‡`,
      baseTags: ['è¯´çœŸè¯', 'äººé—´æ¸…é†’', 'ç†æ€§åˆ†æ', 'é¿å‘æŒ‡å—', 'æ·±åº¦æ€è€ƒ'],
      imageSuggestion: 'è­¦ç¤ºé£æ ¼çš„é…å›¾ï¼Œå¯ä»¥ç”¨çº¢å‰ã€æ„Ÿå¹å·ç­‰å…ƒç´ ï¼Œè§†è§‰å†²å‡»åŠ›å¼º'
    },
    {
      content: () => `ğŸ“Š${displayTopic}è¡Œä¸šæ•°æ®ï½œçœŸç›¸å¯èƒ½ä¼šè®©ä½ å¤±æœ›

åš${displayTopic}3å¹´ï¼Œçœ‹è¿‡å¤ªå¤šäººè¢«å‰²éŸ­èœã€è¢«å¿½æ‚ 
ä»Šå¤©ç”¨çœŸå®æ•°æ®è¯´è¯ï¼Œä¸å¹ä¸é»‘ğŸ‘‡

ğŸ” è¡Œä¸šçœŸå®æ•°æ®æ›å…‰ï¼š

â€¢ ${displayTopic}ä»ä¸šè€…ä¸­ï¼Œæœˆå…¥è¿‡ä¸‡çš„ä¸åˆ°5%
â€¢ 80%çš„äººåš${displayTopic}3ä¸ªæœˆå†…å°±æ”¾å¼ƒç¦»åœº
â€¢ å¹³å‡å›æœ¬å‘¨æœŸæ˜¯6-12ä¸ªæœˆï¼Œç”šè‡³æ›´ä¹…
â€¢ åªæœ‰ä¸åˆ°10%çš„äººèƒ½åšæŒ1å¹´ä»¥ä¸Šå¹¶è·å¾—ç¨³å®šæ”¶ç›Š

ğŸ“‰ ä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†äººåš${displayTopic}åšä¸æˆï¼Ÿ

âŒ è¢«ç½‘ä¸Šæµ®å¤¸çš„æ¡ˆä¾‹å’Œæˆªå›¾è¯¯å¯¼
ä»¥ä¸ºåš${displayTopic}å¾ˆè½»æ¾å°±èƒ½èµšé’±ï¼Œç°å®å¾ˆéª¨æ„Ÿ
âŒ ä½ä¼°äº†éš¾åº¦ï¼Œé«˜ä¼°äº†è‡ªå·±çš„æ‰§è¡ŒåŠ›å’Œè€å¿ƒ
âŒ æ²¡æœ‰é•¿æœŸä¸»ä¹‰å¿ƒæ€ï¼Œæƒ³å¿«é€Ÿè§æ•ˆã€ä¸€å¤œæš´å¯Œ

âœ… ä»€ä¹ˆæ ·çš„äººé€‚åˆåš${displayTopic}ï¼Ÿ

æ ¹æ®æˆ‘çš„è§‚å¯Ÿï¼Œèƒ½åšå‡ºæˆç»©çš„äººéƒ½æœ‰è¿™äº›ç‰¹è´¨ï¼š
â€¢ å¯¹${displayTopic}æœ‰çœŸæ­£çš„çƒ­æƒ…å’Œå†…åœ¨é©±åŠ¨åŠ›
â€¢ æ„¿æ„æŒç»­å­¦ä¹ ã€ä¸æ–­è¿­ä»£ã€æ¥å—å¤±è´¥
â€¢ æœ‰è‡³å°‘6ä¸ªæœˆçš„ç”Ÿæ´»è´¹å‚¨å¤‡ï¼Œèƒ½æ‰¿å—æ²¡æ”¶å…¥çš„å‹åŠ›
â€¢ å¿ƒæ€å¥½ï¼Œèƒ½æ¥å—å¤±è´¥å’ŒæŒ«æŠ˜ï¼Œä¸ç»ç’ƒå¿ƒ

ğŸ¯ å¦‚æœä½ æƒ³åš${displayTopic}ï¼Œæˆ‘çš„å»ºè®®ï¼š
å…ˆå°æˆæœ¬è¯•é”™ï¼ŒéªŒè¯è‡ªå·±é€‚ä¸é€‚åˆ
åˆ«ä¸€ä¸Šæ¥å°±è¾èŒall inï¼Œé£é™©å¤ªå¤§

æ•°æ®ä¸ä¼šéª—äººï¼Œç†æ€§å†³ç­–å¾ˆé‡è¦
è§‰å¾—æœ‰ç”¨çš„è½¬å‘ç»™èº«è¾¹æƒ³åš${displayTopic}çš„äººğŸ‘‡`,
      baseTags: ['æ•°æ®åˆ†æ', 'è¡Œä¸šçœŸç›¸', 'ç†æ€§å†³ç­–', 'é¿å‘æŒ‡å—', 'æ·±åº¦æ´å¯Ÿ'],
      imageSuggestion: 'æ•°æ®å›¾è¡¨é£æ ¼é…å›¾ï¼ŒæŸ±çŠ¶å›¾æˆ–é¥¼å›¾å±•ç¤ºæ•°æ®ï¼Œä¸“ä¸šå•†åŠ¡æ„Ÿ'
    },
    {
      content: () => `ğŸ’£${displayTopic}è¡Œä¸šçš„å¥—è·¯ï½œåˆ«å†è¢«æ”¶å‰²äº†ï¼

è¯´ç‚¹${displayTopic}è¡Œä¸šçš„å†…å¹•å’Œå¥—è·¯
å¯èƒ½ä¼šå¾—ç½ªäººï¼Œä½†çœ‹åˆ°å°±æ˜¯èµšåˆ°ï¼Œèƒ½æ•‘ä¸€ä¸ªæ˜¯ä¸€ä¸ªğŸ‘‡

ğŸª æ­ç§˜${displayTopic}é¢†åŸŸå¸¸è§å¥—è·¯ï¼š

å¥—è·¯1ï¼šåˆ¶é€ ç„¦è™‘
"å†ä¸å­¦${displayTopic}å°±è¦è¢«æ·˜æ±°äº†"
"åˆ«äººéƒ½åœ¨åš${displayTopic}æœˆå…¥åä¸‡ï¼Œä½ è¿˜åœ¨ç­‰ä»€ä¹ˆ"
â†’ åˆ©ç”¨ä½ çš„ç„¦è™‘æ„Ÿé€¼ä½ å†²åŠ¨æ¶ˆè´¹ä¹°è¯¾

å¥—è·¯2ï¼šå¤¸å¤§æ”¶ç›Šï¼Œé€ å‡æˆªå›¾
æ™’æ”¶å…¥æˆªå›¾ï¼Œè¯´åš${displayTopic}è½»æ¾æœˆå…¥åä¸‡
â†’ è¦ä¹ˆæ˜¯Pçš„ï¼Œè¦ä¹ˆæ˜¯æå°‘æ•°æ¡ˆä¾‹
  å¤§éƒ¨åˆ†äººæ ¹æœ¬è¾¾ä¸åˆ°é‚£ä¸ªæ°´å¹³

å¥—è·¯3ï¼šé™æ—¶é™é‡ï¼Œé¥¥é¥¿è¥é”€
"æœ€å3ä¸ªåé¢"
"æ¶¨ä»·å€’è®¡æ—¶ï¼Œé”™è¿‡ç­‰ä¸€å¹´"
â†’ åˆ¶é€ ç´§è¿«æ„Ÿï¼Œè®©ä½ æ¥ä¸åŠæ€è€ƒå°±ä¸‹å•

å¥—è·¯4ï¼šåŒ…è£…"å¯¼å¸ˆ"äººè®¾
ç®€å†é€ å‡ï¼Œç»éªŒæ³¨æ°´ï¼Œå¤´è¡”ä¸€å †
â†’ è‡ªå·±éƒ½æ²¡ææ˜ç™½${displayTopic}ï¼Œå°±æ¥æ•™åˆ«äººï¼Œè¯¯äººå­å¼Ÿ

ğŸ›¡ï¸ å¦‚ä½•é¿å‘ï¼Ÿ

âœ… å‡¡æ˜¯è¦ä½ å…ˆäº¤å¤§é¢å­¦è´¹çš„ï¼Œå¤šç•™ä¸ªå¿ƒçœ¼
âœ… æ”¶ç›Šæ‰¿è¯ºè¶Šå¤¸å¼ ï¼Œè¶Šè¦è­¦æƒ•ï¼Œå¤©ä¸Šä¸ä¼šæ‰é¦…é¥¼
âœ… å¤šæŸ¥èƒŒæ™¯ï¼Œä¸è¦åªå¬ä¸€é¢ä¹‹è¯ï¼Œå»ç¬¬ä¸‰æ–¹å¹³å°éªŒè¯
âœ… å°æˆæœ¬è¯•é”™ï¼Œåˆ«ä¸€ä¸Šæ¥å°±å¤§é¢æŠ•å…¥ï¼Œé™ä½é£é™©

ğŸ’­ è¯´è¿™äº›ä¸æ˜¯åŠé€€
è€Œæ˜¯å¸Œæœ›å¤§å®¶ç†æ€§å¯¹å¾…${displayTopic}
ä¸è¦è¢«ç„¦è™‘ç»‘æ¶ï¼Œä¸è¦è¢«å¥—è·¯æ”¶å‰²

è½¬å‘ç»™èº«è¾¹æƒ³åš${displayTopic}çš„æœ‹å‹
èƒ½æ•‘ä¸€ä¸ªæ˜¯ä¸€ä¸ªï¼ğŸ‘‡`,
      baseTags: ['è¡Œä¸šå†…å¹•', 'é¿å‘æŒ‡å—', 'é˜²éª—æŒ‡å—', 'äººé—´æ¸…é†’', 'è¯´çœŸè¯'],
      imageSuggestion: 'è­¦ç¤ºçˆ†æ–™é£æ ¼é…å›¾ï¼Œå¯ä»¥ç”¨æ­éœ²ã€æ‹†ç©¿ç­‰è§†è§‰å…ƒç´ ï¼Œçº¢é»‘è‰²è°ƒ'
    }
  ];

  const allTemplates: Record<string, Array<{content: () => string, baseTags: string[], imageSuggestion: string}>> = {
    'å¹²è´§': ganhuoTemplates,
    'æƒ…æ„Ÿ': qingganTemplates,
    'äº‰è®®': zhengyiTemplates
  };

  const styleTemplates = allTemplates[style] || ganhuoTemplates;
  const template = styleTemplates[variation % styleTemplates.length];
  
  // ç”Ÿæˆä¸ topic ç›¸å…³çš„æ ‡ç­¾
  const topicTag = coreTopic.length > 4 ? coreTopic.slice(0, 6) : coreTopic;
  const finalTags = [topicTag, ...template.baseTags.slice(0, 4)];
  
  return {
    content: template.content(),
    tags: finalTags,
    imageSuggestion: template.imageSuggestion
  };
}

// ===== API è°ƒç”¨å‡½æ•° =====
async function callMinimaxAPI(prompt: string, systemPrompt: string): Promise<string> {
  const apiKey = process.env.MINIMAX_API_KEY;
  
  if (!apiKey) {
    throw new Error('MINIMAX_API_KEY not configured');
  }

  try {
    const response = await fetch('https://api.minimaxi.com/v1/text/chatcompletion_v2', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: 'MiniMax-Text-01',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: prompt }
        ],
        max_tokens: 1500,
        temperature: 0.9,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Minimax API error:', errorText);
      throw new Error(`API error: ${response.status}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || data.choices?.[0]?.text || '';
  } catch (error) {
    console.error('Minimax API call failed:', error);
    throw error;
  }
}

async function callKimiAPI(prompt: string, systemPrompt: string): Promise<string> {
  const apiKey = process.env.KIMI_API_KEY;
  
  if (!apiKey) {
    throw new Error('KIMI_API_KEY not configured');
  }

  try {
    const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: 'kimi-k2.5',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: prompt }
        ],
        max_tokens: 1500,
        temperature: 0.9,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Kimi API error:', errorText);
      throw new Error(`API error: ${response.status}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || '';
  } catch (error) {
    console.error('Kimi API call failed:', error);
    throw error;
  }
}

// ===== ç”Ÿæˆç³»ç»Ÿæç¤ºè¯ =====
function createSystemPrompt(style: string): string {
  const styleConfigs: Record<string, {tone: string, structure: string[], hooks: string[]}> = {
    'å¹²è´§': {
      tone: 'ä¸“ä¸šä½†ä¸è£…é€¼ï¼Œåƒç»éªŒä¸°å¯Œçš„é—ºèœœåˆ†äº«å¿ƒå¾—ï¼Œå£è¯­åŒ–çœŸå®',
      structure: [
        'ã€ç—›ç‚¹é’©å­ã€‘ç”¨å…·ä½“åœºæ™¯æˆ–æƒŠäººæ•°æ®å¼€ç¯‡ï¼Œåˆ¶é€ ç´§è¿«æ„Ÿ',
        'ã€ä¸ªäººç»å†ã€‘ç®€çŸ­åˆ†äº«è‡ªå·±åœ¨è¯¥é¢†åŸŸçš„çœŸå®ç»å†ï¼Œå»ºç«‹å¯ä¿¡åº¦',
        'ã€å¹²è´§ä¸»ä½“ã€‘3-5ä¸ªå…·ä½“å¯æ“ä½œçš„æ­¥éª¤/æŠ€å·§ï¼Œæ¯ç‚¹éƒ½è¦æœ‰å®é™…ä»·å€¼',
        'ã€é¿å‘æé†’ã€‘åˆ—å‡º2-3ä¸ªå¸¸è§é”™è¯¯ï¼Œæ˜¾å¾—ä¸“ä¸šè´´å¿ƒ',
        'ã€è¡ŒåŠ¨å·å¬ã€‘é¼“åŠ±å°è¯• + å¼•å¯¼è¯„è®ºäº’åŠ¨'
      ],
      hooks: ['å¾ˆå¤šäººä¸çŸ¥é“', 'åæ‚”æ²¡æ—©ç‚¹', '90%çš„äººéƒ½é”™äº†', 'äº²æµ‹æœ‰æ•ˆ', 'è¢«é—®äº†ä¸€ç™¾é']
    },
    'æƒ…æ„Ÿ': {
      tone: 'çœŸè¯šæ¸©æš–ï¼Œåƒæ·±å¤œå’Œé—ºèœœå€¾è¯‰å¿ƒäº‹ï¼Œæœ‰ç”»é¢æ„Ÿå’Œç»†èŠ‚',
      structure: [
        'ã€æƒ…ç»ªé’©å­ã€‘ç”¨å…·ä½“åœºæ™¯æå†™æˆ–é‡‘å¥å¼€å¤´ï¼Œå¼•å‘å…±é¸£',
        'ã€çœŸå®æ•…äº‹ã€‘åˆ†äº«è‡ªå·±çš„ç»å†ï¼Œç»†èŠ‚è¦å…·ä½“æœ‰ç”»é¢æ„Ÿï¼Œä¸èƒ½ç©ºæ´',
        'ã€æƒ…æ„Ÿå‡åã€‘ä»ä¸ªäººç»å†æç‚¼å‡ºæ™®é€‚æ€§æ„Ÿæ‚Ÿï¼Œè®©è¯»è€…æœ‰æ”¶è·',
        'ã€æ¸©æš–æ”¶æŸã€‘ç»™äºˆé¼“åŠ±å’ŒåŠ›é‡ï¼Œä¼ é€’æ­£èƒ½é‡',
        'ã€å…±æƒ…äº’åŠ¨ã€‘é‚€è¯·è¯»è€…åˆ†äº«è‡ªå·±çš„æ•…äº‹æˆ–æ„Ÿå—'
      ],
      hooks: ['å§å¦¹ä»¬è°æ‡‚å•Š', 'æ·±å¤œæƒ³è¯´ç‚¹å¿ƒé‡Œè¯', 'ä»Šå¤©è¢«ç‹ ç‹ æˆ³åˆ°äº†', 'å…³äºè¿™ä»¶äº‹', 'æƒ³è·Ÿå¤§å®¶åˆ†äº«']
    },
    'äº‰è®®': {
      tone: 'çŠ€åˆ©ä½†æœ‰ç†æœ‰æ®ï¼Œæ•¢äºè¯´çœŸè¯ä½†ä¸åæ¿€ï¼Œç”¨æ•°æ®æ”¯æ’‘',
      structure: [
        'ã€äº‰è®®é’©å­ã€‘æ ‡é¢˜å…šå¼€å¤´ï¼Œåˆ¶é€ æ‚¬å¿µæˆ–å¯¹ç«‹ï¼Œä½†è¦ç«™å¾—ä½è„š',
        'ã€è§‚ç‚¹äº®æ˜ã€‘æ˜ç¡®è¡¨è¾¾ä¸éšæ³¢é€æµçš„æ€åº¦ï¼Œäº®å‡ºæ ¸å¿ƒè§‚ç‚¹',
        'ã€äº‹å®è®ºæ®ã€‘ç”¨å…·ä½“æ•°æ®æˆ–æ¡ˆä¾‹æ”¯æ’‘è§‚ç‚¹ï¼Œæ˜¾å¾—æœ‰ç†æœ‰æ®',
        'ã€æ·±åº¦åˆ†æã€‘æ­ç¤ºè¡Œä¸š/ç°è±¡çš„å¦ä¸€é¢ï¼Œæä¾›ç‹¬åˆ°è§è§£',
        'ã€ç†æ€§å‘¼åã€‘å¼•å¯¼ç‹¬ç«‹æ€è€ƒ + å¼€æ”¾å¼è®¨è®ºï¼Œä¸å¼ºè¡Œè¯´æœ'
      ],
      hooks: ['è¯´ç‚¹å¾—ç½ªäººçš„', 'åˆ«æ€¥ç€å–·æˆ‘', 'çœŸç›¸å¯èƒ½ä¼šè®©ä½ ', 'æ¸…é†’ä¸€ç‚¹', 'ä»Šå¤©å¿…é¡»è¯´è¯´']
    }
  };
  
  const config = styleConfigs[style] || styleConfigs['å¹²è´§'];
  const buzzwords = BUZZWORDS[style as keyof typeof BUZZWORDS].join('ã€');
  
  return `ä½ æ˜¯å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆä¸“å®¶ï¼Œæ“…é•¿åˆ›ä½œèƒ½å¼•å‘é«˜äº’åŠ¨ã€é«˜æ”¶è—çš„çˆ†æ¬¾ç¬”è®°ã€‚

ã€ä½ çš„å†™ä½œé£æ ¼ã€‘
- ${config.tone}
- å–„ç”¨emojiå¢åŠ è§†è§‰å¸å¼•åŠ›ï¼Œä½†ä¸èƒ½è¿‡åº¦
- å†…å®¹å¿…é¡»ç´§æ‰£ä¸»é¢˜ï¼Œä¸èƒ½æ³›æ³›è€Œè°ˆ

ã€å†…å®¹ç»“æ„è¦æ±‚ã€‘
${config.structure.map((s, i) => `${i + 1}. ${s}`).join('\n')}

ã€å¿…é¡»ä½¿ç”¨çš„çƒ­è¯ã€‘
ä»ä»¥ä¸‹è¯æ±‡ä¸­é€‰æ‹©2-4ä¸ªè‡ªç„¶èå…¥æ­£æ–‡ï¼š${buzzwords}

ã€çˆ†æ¬¾é’©å­å¼€å¤´å‚è€ƒã€‘
å¯ä»¥ä»ä»¥ä¸‹è§’åº¦é€‰æ‹©ï¼š${config.hooks.join('ã€')}

ã€æ ¸å¿ƒè¦æ±‚ - å¿…é¡»éµå®ˆã€‘
1. æ ‡é¢˜å¿…é¡»åŒ…å«ä¸»é¢˜å…³é”®è¯ï¼Œ15-25å­—ï¼Œä½¿ç”¨2-3ä¸ªemoji
2. æ­£æ–‡å¿…é¡»å›´ç»•ä¸»é¢˜å±•å¼€ï¼Œæ¯ä¸ªæ®µè½éƒ½è¦æåŠæˆ–å…³è”ä¸»é¢˜
3. å†…å®¹è¦æœ‰å…·ä½“ç»†èŠ‚å’Œå¹²è´§ï¼Œä¸èƒ½æ˜¯ç©ºæ³›çš„æ¨¡æ¿
4. ç¦æ­¢ç”Ÿæˆé€šç”¨æ¨¡æ¿å†…å®¹ï¼Œå¿…é¡»é’ˆå¯¹å…·ä½“ä¸»é¢˜å®šåˆ¶
5. ä¸‰ä¸ªä¸åŒç‰ˆæœ¬å¿…é¡»æœ‰æ˜æ˜¾å·®å¼‚ï¼Œåˆ‡å…¥è§’åº¦å®Œå…¨ä¸åŒ

ã€è¾“å‡ºè¦æ±‚ã€‘
- æ­£æ–‡300-500å­—ï¼Œåˆ†æ®µæ¸…æ™°ï¼Œæ¯æ®µç”¨emojiå¼€å¤´
- æ ‡ç­¾5ä¸ªï¼Œä¸å†…å®¹å’Œä¸»é¢˜é«˜åº¦ç›¸å…³
- å¿…é¡»è¾“å‡ºæœ‰æ•ˆJSONæ ¼å¼`;
}

// ===== ç”Ÿæˆç”¨æˆ·æç¤ºè¯ =====
function createPrompt(topic: string, style: string, variation: number): string {
  // ä¸‰ä¸ªç‰ˆæœ¬å®Œå…¨ä¸åŒçš„åˆ‡å…¥è§’åº¦ï¼Œç¡®ä¿å¤šæ ·æ€§
  const ganhuoAngles = [
    {
      title: 'å…¥é—¨é¿å‘è§’åº¦',
      desc: `ä»¥"æ–°æ‰‹å¯¼å¸ˆ"èº«ä»½ï¼Œåˆ†äº«åˆšå¼€å§‹æ¥è§¦${topic}æ—¶è¸©è¿‡çš„å‘å’Œèµ°è¿‡çš„å¼¯è·¯ï¼Œè¯­æ°”åƒé—ºèœœåæ§½ä½†ç»™å‡ºå®ç”¨å»ºè®®ã€‚é‡ç‚¹è®²ï¼š1)æ–°æ‰‹æœ€å®¹æ˜“çŠ¯çš„3ä¸ªé”™è¯¯ 2)æ­£ç¡®çš„å…¥é—¨è·¯å¾„ 3)å­¦ä¹ èµ„æºæ¨èã€‚è¦æœ‰å…·ä½“ç»†èŠ‚ï¼Œä¸èƒ½æ³›æ³›è€Œè°ˆã€‚`
    },
    {
      title: 'è¿›é˜¶ç»éªŒè§’åº¦',
      desc: `ä»¥"è¿‡æ¥äºº"èº«ä»½ï¼Œåˆ†äº«åš${topic}1å¹´+çš„è¿›é˜¶å¿ƒå¾—å’Œå‹ç®±åº•æŠ€å·§ã€‚é‡ç‚¹è®²ï¼š1)ä»å…¥é—¨åˆ°ç²¾é€šçš„å…³é”®è½¬æŠ˜ç‚¹ 2)5ä¸ªæå‡æ•ˆç‡çš„æ ¸å¿ƒæ–¹æ³• 3)çœŸå®çš„æˆé•¿æ—¶é—´çº¿å’Œé‡Œç¨‹ç¢‘ã€‚è¦æœ‰å…·ä½“æ¡ˆä¾‹æ”¯æ’‘ã€‚`
    },
    {
      title: 'å·¥å…·æ–¹æ³•è§’åº¦',
      desc: `ä»¥"æ•ˆç‡è¾¾äºº"èº«ä»½ï¼Œåˆ†äº«åš${topic}å¿…å¤‡çš„5ä¸ªç¥å™¨å·¥å…·ã€‚é‡ç‚¹è®²ï¼š1)æ¯ä¸ªå·¥å…·çš„å…·ä½“ç”¨é€” 2)å¦‚ä½•ç»„åˆä½¿ç”¨æå‡æ•ˆç‡ 3)äº²æµ‹ä½¿ç”¨æ•ˆæœå’ŒèŠ‚çœçš„æ—¶é—´ã€‚å·¥å…·åç§°å¯ä»¥ç”¨XXä»£æ›¿ï¼Œä½†è¦è¯´æ˜åŠŸèƒ½ã€‚`
    }
  ];
  
  const qingganAngles = [
    {
      title: 'æˆé•¿æ„Ÿæ‚Ÿè§’åº¦',
      desc: `ä»¥"çŸ¥å¿ƒå§å§"èº«ä»½ï¼Œåˆ†äº«æ¥è§¦${topic}3å¹´æ¥çš„å¿ƒè·¯å†ç¨‹ã€‚é‡ç‚¹è®²ï¼š1)åˆšå¼€å§‹çš„ç¾å¥½æ†§æ†¬ 2)é‡åˆ°çš„æŒ«æŠ˜å’Œä½è°· 3)è½¬æŠ˜ç‚¹å’Œé¡¿æ‚Ÿæ—¶åˆ» 4)ç°åœ¨çš„æ„Ÿæ‚Ÿã€‚è¦æœ‰çœŸå®çš„æƒ…æ„Ÿèµ·ä¼ï¼Œå¼•å‘å…±é¸£ã€‚`
    },
    {
      title: 'åšæŒä¸æ˜“è§’åº¦',
      desc: `ä»¥"åŒè¡Œè€…"èº«ä»½ï¼Œåˆ†äº«åšæŒ${topic}100å¤©çš„çœŸå®è®°å½•ã€‚é‡ç‚¹è®²ï¼š1)é‚£äº›æƒ³è¦æ”¾å¼ƒçš„ç¬é—´ 2)æ”¶åˆ°çš„é¼“åŠ±å’Œæ”¯æŒ 3)åšæŒä¸‹æ¥çš„ç†ç”± 4)ç»™åŒæ ·åœ¨åšæŒçš„äººçš„è¯ã€‚è¦çœŸå®ä¸ç…½æƒ…ã€‚`
    },
    {
      title: 'æ”¹å˜äººç”Ÿè§’åº¦',
      desc: `ä»¥"å—ç›Šè€…"èº«ä»½ï¼Œåˆ†äº«${topic}å¦‚ä½•æ”¹å˜äº†è‡ªå·±çš„äººç”Ÿè½¨è¿¹ã€‚é‡ç‚¹è®²ï¼š1)æ¥è§¦${topic}å‰çš„ç”Ÿæ´»çŠ¶æ€ 2)${topic}å¸¦æ¥çš„å…·ä½“æ”¹å˜ 3)ç°åœ¨å’Œè¿‡å»çš„å¯¹æ¯” 4)æƒ³å¯¹çŠ¹è±«ä¸­çš„äººè¯´ã€‚è¦æ¸©æš–æ²»æ„ˆæœ‰åŠ›é‡ã€‚`
    }
  ];
  
  const zhengyiAngles = [
    {
      title: 'çœŸç›¸æ­ç§˜è§’åº¦',
      desc: `ä»¥"è¯´çœŸè¯çš„äºº"èº«ä»½ï¼Œæ­éœ²${topic}ä¸ä¸ºäººçŸ¥çš„çœŸç›¸ã€‚é‡ç‚¹è®²ï¼š1)3ä¸ªæ²¡äººæ•¢è¯´çš„æ®‹é…·äº‹å® 2)ä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†äººä¼šå¤±è´¥ 3)ä»€ä¹ˆæ ·çš„äººçœŸçš„é€‚åˆã€‚è¦æœ‰ç†æœ‰æ®ï¼Œä¸æ€•å¾—ç½ªäººä½†ä¹Ÿè¦å®¢è§‚ã€‚`
    },
    {
      title: 'æ•°æ®åˆ†æè§’åº¦',
      desc: `ä»¥"è¡Œä¸šè§‚å¯Ÿè€…"èº«ä»½ï¼Œç”¨æ•°æ®æ­ç¤º${topic}çš„çœŸå®æƒ…å†µã€‚é‡ç‚¹è®²ï¼š1)è¡Œä¸šçœŸå®æ•°æ®ï¼ˆæˆåŠŸç‡ã€æ”¶å…¥åˆ†å¸ƒã€å‘¨æœŸï¼‰ 2)å¤±è´¥çš„ä¸»è¦åŸå› åˆ†æ 3)ç†æ€§å…¥è¡Œå»ºè®®ã€‚æ•°æ®å¯ä»¥åˆç†æ¨æµ‹ä½†è¦æ ‡æ³¨æ˜¯ä¼°ç®—ã€‚`
    },
    {
      title: 'å¥—è·¯æ›å…‰è§’åº¦',
      desc: `ä»¥"é˜²éª—å«å£«"èº«ä»½ï¼Œæ›å…‰${topic}é¢†åŸŸçš„å¸¸è§å¥—è·¯å’Œéª—å±€ã€‚é‡ç‚¹è®²ï¼š1)4ä¸ªå¸¸è§æ”¶å‰²å¥—è·¯ 2)å¦‚ä½•è¯†åˆ«å’Œé¿å‘ 3)ä¿æŠ¤è‡ªå·±ä¸è¢«å‰²éŸ­èœçš„æ–¹æ³•ã€‚è¦å…·ä½“æŒ‡å‡ºå¥—è·¯æ‰‹æ³•ã€‚`
    }
  ];
  
  const allAngles: Record<string, Array<{title: string, desc: string}>> = {
    'å¹²è´§': ganhuoAngles,
    'æƒ…æ„Ÿ': qingganAngles,
    'äº‰è®®': zhengyiAngles
  };
  
  const angles = allAngles[style] || ganhuoAngles;
  const angle = angles[variation % angles.length];

  return `è¯·ä¸º"${topic}"åˆ›ä½œä¸€ç¯‡${style}é£æ ¼çš„å°çº¢ä¹¦æ–‡æ¡ˆã€‚

ã€åˆ‡å…¥è§’åº¦ã€‘${angle.title}
${angle.desc}

ã€å…³é”®è¦æ±‚ã€‘
1. æ­£æ–‡å¿…é¡»å¤šæ¬¡æåŠ"${topic}"ï¼Œå›´ç»•è¿™ä¸ªä¸»é¢˜å±•å¼€å…·ä½“å†…å®¹
2. ç¦æ­¢ç”Ÿæˆé€šç”¨æ¨¡æ¿ï¼Œæ‰€æœ‰å†…å®¹éƒ½è¦é’ˆå¯¹"${topic}"å®šåˆ¶
3. è¦æœ‰å…·ä½“ç»†èŠ‚ã€æ¡ˆä¾‹æˆ–æ•°æ®ï¼Œä¸èƒ½ç©ºæ´è¯´æ•™
4. ä½¿ç”¨2-4ä¸ªemojiå¢åŠ è§†è§‰å¸å¼•åŠ›
5. ç»“å°¾å¼•å¯¼è¯„è®ºäº’åŠ¨

ã€è¾“å‡ºæ ¼å¼ã€‘
å¿…é¡»è¾“å‡ºä»¥ä¸‹JSONæ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–å†…å®¹ï¼š
{
  "content": "æ ‡é¢˜\\n\\næ­£æ–‡å†…å®¹ï¼ˆç”¨\\næ¢è¡Œï¼ŒåŒ…å«emojiï¼‰",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2", "æ ‡ç­¾3", "æ ‡ç­¾4", "æ ‡ç­¾5"],
  "imageSuggestion": "é…å›¾å»ºè®®æè¿°ï¼ˆç”»é¢é£æ ¼ã€é…è‰²ã€å…ƒç´ ï¼‰"
}`;
}

// ===== å¢å¼ºç‰ˆ AI å“åº”è§£æ =====
function parseAIResponse(content: string, style: string, topic: string): GeneratedContent {
  console.log('Parsing AI response:', content.substring(0, 200) + '...');
  
  try {
    // å°è¯•å¤šç§æ–¹å¼æå– JSON
    let jsonStr = '';
    
    // æ–¹æ³•1: ç›´æ¥åŒ¹é… { ... }
    const jsonMatch = content.match(/\{[\s\S]*?\}(?=\s*$|\s*\n)/);
    if (jsonMatch) {
      jsonStr = jsonMatch[0];
    }
    
    // æ–¹æ³•2: åŒ¹é… ```json ... ``` ä»£ç å—
    if (!jsonStr) {
      const codeBlockMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
      if (codeBlockMatch) {
        jsonStr = codeBlockMatch[1].trim();
      }
    }
    
    // æ–¹æ³•3: æ‰¾åˆ°ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª }
    if (!jsonStr) {
      const startIdx = content.indexOf('{');
      const endIdx = content.lastIndexOf('}');
      if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
        jsonStr = content.substring(startIdx, endIdx + 1);
      }
    }
    
    if (jsonStr) {
      // æ¸…ç†å¯èƒ½çš„æ ¼å¼é—®é¢˜
      jsonStr = jsonStr
        .replace(/\n\s*\/\/.*$/gm, '') // ç§»é™¤æ³¨é‡Š
        .replace(/,\s*([}\]])/g, '$1'); // ç§»é™¤å°¾éšé€—å·
      
      const parsed = JSON.parse(jsonStr);
      
      return {
        content: parsed.content || content,
        tags: Array.isArray(parsed.tags) ? parsed.tags.slice(0, 5) : generateDefaultTags(topic, style),
        imageSuggestion: parsed.imageSuggestion || generateDefaultImageSuggestion(style),
      };
    }
  } catch (e) {
    console.error('JSON parse failed:', e);
    // å°è¯•ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯
    return extractFromText(content, style);
  }
  
  // å®Œå…¨æ— æ³•è§£æï¼Œä½¿ç”¨æ–‡æœ¬æå–
  return extractFromText(content, style);
}

// ä»çº¯æ–‡æœ¬ä¸­æå–ä¿¡æ¯
function extractFromText(content: string, style: string): GeneratedContent {
  const lines = content.split('\n').filter(line => line.trim());
  
  // ç¬¬ä¸€è¡Œé€šå¸¸åŒ…å«æ ‡é¢˜
  const title = lines[0] || 'å°çº¢ä¹¦æ–‡æ¡ˆåˆ†äº«';
  
  // å…¶ä½™æ˜¯æ­£æ–‡
  const body = lines.slice(1).join('\n');
  
  return {
    content: `${title}\n\n${body}`,
    tags: generateDefaultTags('', style),
    imageSuggestion: generateDefaultImageSuggestion(style)
  };
}

// ç”Ÿæˆé»˜è®¤æ ‡ç­¾
function generateDefaultTags(topic: string, style: string): string[] {
  const baseTags: Record<string, string[]> = {
    'å¹²è´§': ['å¹²è´§æ»¡æ»¡', 'å»ºè®®æ”¶è—', 'ç»éªŒåˆ†äº«', 'å®ç”¨æŠ€å·§', 'é¿å‘æŒ‡å—'],
    'æƒ…æ„Ÿ': ['æƒ…æ„Ÿå…±é¸£', 'æ²»æ„ˆç³»', 'çœŸå®åˆ†äº«', 'æ¸©æš–', 'æ·±å¤œæ ‘æ´'],
    'äº‰è®®': ['äººé—´æ¸…é†’', 'è¯´çœŸè¯', 'æ·±åº¦æ€è€ƒ', 'é¿å‘æŒ‡å—', 'å¿…çœ‹']
  };
  return baseTags[style] || baseTags['å¹²è´§'];
}

// ç”Ÿæˆé»˜è®¤é…å›¾å»ºè®®
function generateDefaultImageSuggestion(style: string): string {
  const suggestions: Record<string, string> = {
    'å¹²è´§': 'ä¸“ä¸šé£æ ¼çš„æ•™ç¨‹é…å›¾ï¼Œæ¸…æ™°çš„æ­¥éª¤å±•ç¤ºï¼Œæ˜äº®æ•´æ´çš„æ¡Œé¢åœºæ™¯',
    'æƒ…æ„Ÿ': 'æ¸©æš–æ²»æ„ˆçš„é£æ™¯ç…§ï¼ŒæŸ”å’Œå…‰çº¿ï¼Œå¯ä»¥æ˜¯æ—¥å‡ºæ—¥è½æˆ–æ¸©é¦¨å®¤å†…åœºæ™¯',
    'äº‰è®®': 'æœ‰å†²å‡»åŠ›çš„å¯¹æ¯”å›¾æˆ–è­¦ç¤ºé£æ ¼é…å›¾ï¼Œå¼ºçƒˆçš„è§†è§‰å¯¹æ¯”ï¼Œå¼•å‘æ€è€ƒ'
  };
  return suggestions[style] || 'ä¸ä¸»é¢˜ç›¸å…³çš„é«˜è´¨é‡é…å›¾ï¼Œè‰²è°ƒå’Œè°ï¼Œæ„å›¾ç¾è§‚';
}

// ===== ç”Ÿæˆå†…å®¹ï¼ˆå¸¦ fallback å’Œé‡è¯•ï¼‰ =====
async function generateContent(
  topic: string, 
  style: string, 
  variation: number,
  retryCount = 0
): Promise<GeneratedContent> {
  const systemPrompt = createSystemPrompt(style);
  const prompt = createPrompt(topic, style, variation);
  
  const maxRetries = 2;
  
  // å…ˆå°è¯• Minimax
  try {
    console.log(`[${variation}] Trying Minimax...`);
    const content = await callMinimaxAPI(prompt, systemPrompt);
    return parseAIResponse(content, style, topic);
  } catch (minimaxError) {
    console.log(`[${variation}] Minimax failed, trying Kimi...`);
    
    // Minimax å¤±è´¥ï¼Œå°è¯• Kimi
    try {
      const content = await callKimiAPI(prompt, systemPrompt);
      return parseAIResponse(content, style, topic);
    } catch (kimiError) {
      console.log(`[${variation}] Kimi also failed.`);
      
      // å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œé€’å½’é‡è¯•
      if (retryCount < maxRetries) {
        console.log(`[${variation}] Retrying (${retryCount + 1}/${maxRetries})...`);
        await new Promise(resolve => setTimeout(resolve, 1000));
        return generateContent(topic, style, variation, retryCount + 1);
      }
      
      // æ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      console.log(`[${variation}] Using mock content`);
      return generateMockContent(topic, style, variation);
    }
  }
}

// ===== API Route Handler =====
export async function POST(request: NextRequest) {
  try {
    const body: GenerateRequest = await request.json();
    const { topic, style } = body;

    if (!topic || !style) {
      return NextResponse.json(
        { error: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼štopic å’Œ style' },
        { status: 400 }
      );
    }

    if (!['å¹²è´§', 'æƒ…æ„Ÿ', 'äº‰è®®'].includes(style)) {
      return NextResponse.json(
        { error: 'style å¿…é¡»æ˜¯ï¼šå¹²è´§ã€æƒ…æ„Ÿã€äº‰è®®' },
        { status: 400 }
      );
    }

    console.log(`Generating content for: "${topic}" (${style})`);

    // å¹¶è¡Œç”Ÿæˆ3ä¸ªä¸åŒç‰ˆæœ¬
    const results = await Promise.all([
      generateContent(topic, style, 0),
      new Promise<GeneratedContent>(resolve => 
        setTimeout(() => resolve(generateContent(topic, style, 1)), 300)
      ),
      new Promise<GeneratedContent>(resolve => 
        setTimeout(() => resolve(generateContent(topic, style, 2)), 600)
      )
    ]);

    console.log('Generated 3 variations successfully');

    return NextResponse.json({ results });
  } catch (error) {
    console.error('Generate error:', error);
    return NextResponse.json(
      { 
        error: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 
        details: error instanceof Error ? error.message : 'Unknown error' 
      },
      { status: 500 }
    );
  }
}
